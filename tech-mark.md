# 音频标记功能开发文档

## 功能概述

实现音频文件的标记功能，通过声音检测自动添加标记点，并支持手动调整，用于选择要导出的音频片段。系统基于声音阈值和留白时间自动检测有效音频段落，生成对应的开始(绿旗)和结束(红旗)标记。用户可以手动调整这些标记的位置，或根据需要添加、删除标记。

### 核心功能
1. 自动检测并添加标记（基于阈值和留白时间）
2. 手动调整标记（绿旗表示开始，红旗表示结束）
3. 删除标记
4. 标记列表显示和管理

## 界面设计

### 主窗口布局
- 左侧：波形显示区域（现有）
- 右侧：控制面板（新增，宽度300px）
  * 标记列表区
  * 操作按钮区

### 标记列表显示内容
- 序号（从001开始）
- 类型图标（绿旗/红旗）
- 时间点（格式：mm:ss.SSS）
- 配对状态（已配对/未配对）
- 删除按钮

### 标记样式
- 绿旗：2px绿色旗杆 + 15px向右三角形
- 红旗：2px红色旗杆 + 15px向左三角形
- 未配对标记使用半透明样式

## 交互设计

### 添加标记
1. 工具栏按钮：插入绿旗/红旗
2. 右键菜单：在点击位置插入绿旗/红旗
3. 键盘快捷键：
   - S键：插入绿旗
   - E键：插入红旗

### 移动标记
1. 鼠标拖动标记
2. 位置限制：
   - 不能越过其他标记
   - 相邻标记间隔至少1秒
   - 不能超出音频范围

### 删除标记
1. 右键菜单删除
2. 标记列表中删除按钮
3. Delete键删除选中标记

## 数据结构

### 标记对象
```typescript
interface Mark {
  id: string;           // 唯一标识
  type: 'start' | 'end';// 标记类型
  time: number;         // 时间点(秒)
  pairedId: string;     // 配对标记的ID
}
```

### 数据验证规则
1. 标记时间必须在音频范围内
2. 已配对标记间隔至少1秒
3. 允许存在未配对标记
4. 导出时处理未配对标记

## 开发阶段

### 第一阶段：基础功能
1. 实现右侧控制面板布局
2. 实现标记数据结构和管理
3. 实现自动标记功能（使用默认参数）
4. 实现标记的显示
5. 实现标记列表显示

### 第二阶段：交互优化
1. 实现标记的手动创建
2. 实现标记拖动调整
3. 实现标记删除功能
4. 实现右键菜单
5. 实现键盘快捷键

### 第三阶段：导出功能
1. 实现导出验证
2. 实现自动补全方案
3. 实现导出对话框
4. 实现导出进度显示

## 技术要点

### 标记渲染
1. 使用Canvas绘制标记
2. 考虑设备像素比
3. 优化重绘性能
4. 实现标记高亮效果

### 事件处理
1. 鼠标拖动事件
2. 右键菜单事件
3. 键盘事件
4. 标记选中状态管理

### 性能优化
1. 避免频繁重绘
2. 使用请求动画帧
3. 优化数据结构
4. 减少不必要的计算

## 导出处理

### 未配对标记处理
1. 允许临时存在未配对标记
2. 导出时检查并提示
3. 提供三个选项：
   - 手动修复
   - 自动补全并导出
   - 仅导出配对标记

### 自动补全规则
1. 无结束标记的绿旗：
   - 使用下一个绿旗位置
   - 或使用音频结束位置
2. 无开始标记的红旗：
   - 使用上一个红旗位置
   - 或使用音频开始位置

## 注意事项

1. 边界情况处理
   - 音频开始和结束位置
   - 标记重叠情况
   - 快速连续操作

2. 错误处理
   - 标记创建失败
   - 位置调整无效
   - 数据验证失败

3. 性能考虑
   - 大量标记时的渲染
   - 拖动时的实时计算
   - 列表更新效率

4. 用户体验
   - 操作反馈及时
   - 错误提示友好
   - 界面响应流畅
